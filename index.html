<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parcel App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    #app { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select { display: block; margin: 10px 0; padding: 5px; width: 100%; border-radius: 4px; }
    button { padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #0056b3; }
    .hidden { display: none; }
    #parcels-list div { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; }
    #parcels-list div.selected { background: #d1e7fd; }
    #barcode-scanner { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="app">
    <h1>Parcel Management</h1>

    <div id="login-form">
      <h2>Login</h2>
      <input id="login-email" placeholder="Email" />
      <input id="login-password" type="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <button onclick="showRegister()">Register</button>
    </div>

    <div id="register-form" class="hidden">
      <h2>Register</h2>
      <input id="name" placeholder="Name" />
      <input id="unit" placeholder="Unit Number" />
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button onclick="register()">Sign Up</button>
      <button onclick="showLogin()">Back to Login</button>
    </div>

    <div id="dashboard" class="hidden">
      <h2>Welcome, <span id="user-name"></span>!</h2>

      <div id="guard-actions" class="hidden">
        <h3>Log New Parcel</h3>
        <input id="awbNumber" placeholder="AWB Number" />
        <input id="recipientName" placeholder="Recipient Name" />
        <input id="recipientUnit" placeholder="Unit Number" />
        <button onclick="logParcel()">Log Parcel</button>
      </div>

      <div id="resident-actions" class="hidden">
        <h3>Your Parcels</h3>
        <div id="parcels-list"></div>
        <button onclick="collectParcel()">Collect Parcel</button>
      </div>

      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    let token = null;
    let selectedParcelAWB = null;

    function showRegister() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
    }

    function showLogin() {
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }

    async function register() {
      const name = document.getElementById('name').value;
      const unitNumber = document.getElementById('unit').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, unitNumber, email, password }),
      });

      const data = await response.json();
      alert(data.msg);
      if (data.msg === 'Registration successful') {
        showLogin();
      }
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
    
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
        });
    
        const data = await response.json();
    
        if (data.token) {
            token = data.token;
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-name').textContent = email;
    
            if (data.role === 'guard') {
                document.getElementById('guard-actions').classList.remove('hidden');
            } else {
                document.getElementById('resident-actions').classList.remove('hidden');
                loadParcels(); // ✅ Load resident’s parcels immediately after login
            }
            alert(`Logged in as ${data.role}`);
        } else {
            alert(data.msg);
        }
    }
    
    async function logParcel() {
      const awbNumber = document.getElementById('awbNumber').value;
      const recipientName = document.getElementById('recipientName').value;
      const recipientUnit = document.getElementById('recipientUnit').value;

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}` 
        },
        body: JSON.stringify({ awbNumber, recipientName, recipientUnit }),
      });

      const data = await response.json();
      alert(data.msg);
      if (data.msg === 'Parcel logged successfully') {
        document.getElementById('awbNumber').value = '';
        document.getElementById('recipientName').value = '';
        document.getElementById('recipientUnit').value = '';
      }
    }

    async function loadParcels() {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
    
        const parcels = await response.json();
        const parcelsList = document.getElementById('parcels-list');
        parcelsList.innerHTML = ''; // ✅ Clear previous list
    
        if (parcels.length === 0) {
            parcelsList.innerHTML = '<p>No parcels found.</p>'; // ✅ Display message if no parcels
            return;
        }
    
        parcels.forEach(parcel => {
            const div = document.createElement('div');
            div.textContent = `AWB: ${parcel.awb_number} - Delivered: ${parcel.delivered_at ? new Date(parcel.delivered_at).toLocaleString() : 'Pending'}`;
            div.dataset.awbNumber = parcel.awb_number; // ✅ Store AWB number for selection
            div.onclick = () => selectParcel(div); // ✅ Handle selection
            div.style.cursor = "pointer";
            div.style.padding = "10px";
            div.style.borderBottom = "1px solid #ddd";
            parcelsList.appendChild(div);
        });
    }

    function selectParcel(element) {
      document.querySelectorAll("#parcels-list div").forEach(div => div.classList.remove("selected"));
      element.classList.add("selected");
      selectedParcelAWB = element.dataset.awbNumber;
    }

    async function collectParcel() {
      if (!selectedParcelAWB) {
        alert("Please select a parcel first.");
        return;
      }

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels/collect', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}` 
        },
        body: JSON.stringify({ awbNumber: selectedParcelAWB }),
      });

      const data = await response.json();
      alert(data.msg);
      if (data.msg === "Parcel collected successfully") {
        loadParcels();
      }
    }

    function logout() {
      token = null;
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }
  </script>
</body>
</html>
