<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parcel App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    #reader {
      position: relative;
      width: 100%;
      height: 300px;
      border: 1px solid #ccc;
      background: #000;
      overflow: visible;
    }

    #reader video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      z-index: 1;
      display: block !important;
    }

    #reader canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 2;
      display: none;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      max-width: 600px;
      width: 100%;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1, h2, h3, h4 {
      text-align: center;
      margin-bottom: 15px;
    }

    input, select, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .hidden {
      display: none !important;
    }

    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f8f8f8;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    tr.selected {
      background-color: #d1e7fd !important;
    }

    /* Parcel List Styling (Resident Flow) */
    #parcels-list div {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      text-align: center;
    }

    #parcels-list div.selected {
      background: #d1e7fd;
    }

    #scanner {
      z-index: 10;
    }

    .button-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .camera-button {
      width: auto;
      padding: 12px;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      #app {
        width: 90%;
        padding: 15px;
      }

      input, button {
        padding: 10px;
        font-size: 14px;
      }

      h1 {
        font-size: 24px;
      }

      h2, h3, h4 {
        font-size: 18px;
      }

      .camera-button {
        padding: 10px;
        font-size: 14px;
      }

      th, td {
        padding: 10px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      #app {
        width: 95%;
        padding: 10px;
      }

      h1 {
        font-size: 20px;
      }

      h2, h3, h4 {
        font-size: 16px;
      }

      input, button {
        padding: 8px;
        font-size: 12px;
      }

      th, td {
        padding: 8px;
        font-size: 12px;
      }

      .camera-button {
        padding: 8px;
        font-size: 12px;
      }

      #parcels-list div {
        padding: 8px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Parcel Management</h1>

    <div id="login-form">
      <h2>Login</h2>
      <form id="loginForm" onsubmit="event.preventDefault(); login();">
        <input id="login-email" type="email" placeholder="Email" autocomplete="email" required />
        <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" required />
        <button type="submit">Login</button>
      </form>
      <button onclick="showRegister()">Register</button>
    </div>

    <div id="register-form" class="hidden">
      <h2>Register</h2>
      <input id="name" placeholder="Name" autocomplete="name" />
      <input id="unit" placeholder="Unit Number" autocomplete="off" />
      <input id="email" placeholder="Email" autocomplete="email" />
      <input id="password" type="password" placeholder="Password" autocomplete="new-password" />
      <button onclick="register()">Sign Up</button>
      <button onclick="showLogin()">Back to Login</button>
    </div>

    <div id="dashboard" class="hidden">
      <h2>Welcome, <span id="user-name"></span>!</h2>

      <div id="guard-actions" class="hidden">
        <h3>Log New Parcel</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input id="awbNumber" placeholder="AWB Number" autocomplete="off" />
          <button id="scanAWB" onclick="startScannerForAWB()" class="camera-button" aria-label="Scan AWB barcode">
            üì∑
          </button>
        </div>
        <input id="recipientName" placeholder="Recipient Name" autocomplete="name" />
        <input id="recipientUnit" placeholder="Unit Number" autocomplete="off" />
        <button onclick="logParcel()">Log Parcel</button>
      </div>

      <div id="resident-actions" class="hidden">
        <h3>Your Parcels</h3>
        <div id="parcels-list"></div>
        <div class="button-group">
          <button onclick="manualCollectParcel()">Collect Parcel</button>
          <button onclick="startParcelScan()" class="camera-button" aria-label="Scan parcel barcode">
            üì∑
          </button>
        </div>
      </div>

      <div id="admin-actions" class="hidden">
        <h3>Admin Dashboard</h3>
        <div id="admin-main-buttons">
          <button onclick="showAdminUsers()">Users</button>
          <button onclick="showAdminParcels()">Parcels</button>
        </div>

        <div id="admin-users-section" class="hidden">
          <h4>Manage Users</h4>
          <div id="admin-users-list">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Unit</th>
                </tr>
              </thead>
              <tbody id="admin-users-table-body"></tbody>
            </table>
          </div>
          <h4>Add New User</h4>
          <input id="admin-user-name" placeholder="Name" autocomplete="name" />
          <input id="admin-user-unit" placeholder="Unit Number" autocomplete="off" />
          <input id="admin-user-email" placeholder="Email" autocomplete="email" />
          <input id="admin-user-password" type="password" placeholder="Password" autocomplete="new-password" />
          <select id="admin-user-role">
            <option value="resident">Resident</option>
            <option value="guard">Guard</option>
            <option value="admin">Admin</option>
          </select>
          <button onclick="addNewUser()">Add User</button>
          <button onclick="backToAdminMain()">Back</button>
        </div>

        <div id="admin-parcels-section" class="hidden">
          <div id="admin-parcels-buttons">
            <button onclick="showViewParcels()">View Parcels</button>
            <button onclick="showEditParcels()" class="hidden">Edit Parcels</button>
            <button onclick="showAddParcels()">Add Parcels</button>
            <button onclick="showDeleteParcels()">Delete Parcels</button>
            <button onclick="backToAdminMain()">Back</button>
          </div>

          <div id="admin-view-parcels" class="hidden">
            <h4>View Parcels</h4>
            <div id="admin-parcels-list">
              <table>
                <thead>
                  <tr>
                    <th>AWB</th>
                    <th>Recipient</th>
                    <th>Unit</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="admin-parcels-table-body"></tbody>
              </table>
            </div>
          </div>

          <div id="admin-edit-parcels" class="hidden">
            <h4>Edit Parcel</h4>
            <p>Select a parcel to edit its details.</p>
            <div id="admin-parcels-list-edit">
              <table>
                <thead>
                  <tr>
                    <th>AWB</th>
                    <th>Recipient</th>
                    <th>Unit</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="admin-parcels-table-body-edit"></tbody>
              </table>
            </div>
            <input id="edit-awbNumber" placeholder="AWB Number" autocomplete="off" disabled />
            <input id="edit-recipientName" placeholder="Recipient Name" autocomplete="name" />
            <input id="edit-recipientUnit" placeholder="Unit Number" autocomplete="off" />
            <button onclick="saveParcelEdits()">Save Changes</button>
          </div>

          <div id="admin-add-parcels" class="hidden">
            <h4>Add New Parcel</h4>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input id="admin-add-awbNumber" placeholder="AWB Number" autocomplete="off" />
              <button id="admin-scanAWB" onclick="startScannerForAdminAdd()" class="camera-button" aria-label="Scan AWB barcode">
                üì∑
              </button>
            </div>
            <input id="admin-add-recipientName" placeholder="Recipient Name" autocomplete="name" />
            <input id="admin-add-recipientUnit" placeholder="Unit Number" autocomplete="off" />
            <button onclick="adminAddParcel()">Add Parcel</button>
          </div>

          <div id="admin-delete-parcels" class="hidden">
            <h4>Delete Parcels</h4>
            <div id="admin-parcels-list-delete">
              <table>
                <thead>
                  <tr>
                    <th>AWB</th>
                    <th>Recipient</th>
                    <th>Unit</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="admin-parcels-table-body-delete"></tbody>
              </table>
            </div>
            <button onclick="deleteSelectedParcel()">Delete Selected Parcel</button>
          </div>
        </div>
      </div>

      <button onclick="logout()">Logout</button>
    </div>

    <div id="scanner" class="hidden" style="width: 100%; margin-top: 10px;">
      <div id="reader" style="width: 100%; height: 300px; border: 1px solid #ccc;"></div>
      <button onclick="playVideo()">Start Camera</button>
      <input id="manualAWB" placeholder="Enter AWB manually if camera fails" style="margin-top: 10px;" autocomplete="off">
      <button onclick="manualCollectParcel()">Submit Manual AWB</button>
      <button onclick="stopScanner()">‚ùå Close Scanner</button>
    </div>
  </div>

  <script>
    function hideAllSections() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('scanner').classList.add('hidden');
    }

    function hideDashboardSections() {
      document.getElementById('guard-actions').classList.add('hidden');
      document.getElementById('resident-actions').classList.add('hidden');
      document.getElementById('admin-actions').classList.add('hidden');
      document.getElementById('scanner').classList.add('hidden');
    }

    function showRegister() {
      hideAllSections();
      document.getElementById('register-form').classList.remove('hidden');
    }

    function showLogin() {
      hideAllSections();
      document.getElementById('login-form').classList.remove('hidden');
    }

    async function register() {
      console.log("üü¢ register() called");
      const name = document.getElementById('name').value;
      const unitNumber = document.getElementById('unit').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      console.log("üü¢ Form Data:", { name, unitNumber, email, password });

      if (!name || !unitNumber || !email || !password) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, unitNumber, email, password }),
        });

        console.log("üü¢ Fetch Response Status:", response.status);
        const data = await response.json();
        console.log("üü¢ Response Data:", data);

        alert(data.msg);
        if (data.msg === 'Registration successful') {
          showLogin();
        }
      } catch (error) {
        console.error("‚ùå Error during registration:", error);
        alert('Failed to register. Please try again.');
      }
    }

    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (data.token) {
        token = data.token;
        hideAllSections();
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('user-name').textContent = data.name;

        hideDashboardSections();
        if (data.role === 'guard') {
          document.getElementById('guard-actions').classList.remove('hidden');
        } else if (data.role === 'resident') {
          document.getElementById('resident-actions').classList.remove('hidden');
          loadParcels();
        } else if (data.role === 'admin') {
          document.getElementById('admin-actions').classList.remove('hidden');
          showAdminMain();
        }
        alert(`Logged in as ${data.role}`);
      } else {
        alert(data.msg);
      }
    }

    async function logParcel() {
      const awbNumber = document.getElementById('awbNumber').value.trim();
      const recipientName = document.getElementById('recipientName').value.trim();
      const recipientUnit = document.getElementById('recipientUnit').value.trim();

      if (!awbNumber || !recipientName || !recipientUnit) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            awbNumber,
            recipientName,
            recipientUnit
          })
        });

        const data = await response.json();
        if (response.ok) {
          alert(data.msg || 'Parcel logged successfully');
          document.getElementById('awbNumber').value = '';
          document.getElementById('recipientName').value = '';
          document.getElementById('recipientUnit').value = '';
        } else if (response.status === 409) {
          alert('Error: This AWB number is already logged. Please use a unique AWB number.');
        } else {
          alert(`Error: ${data.msg || 'Failed to log parcel. Please try again.'}`);
        }
      } catch (error) {
        console.error('Error logging parcel:', error);
        alert('An unexpected error occurred. Please try again.');
      }
    }

    async function adminAddParcel() {
      const awbNumber = document.getElementById('admin-add-awbNumber').value.trim();
      const recipientName = document.getElementById('admin-add-recipientName').value.trim();
      const recipientUnit = document.getElementById('admin-add-recipientUnit').value.trim();

      if (!awbNumber || !recipientName || !recipientUnit) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            awbNumber,
            recipientName,
            recipientUnit
          })
        });

        const data = await response.json();
        if (response.ok) {
          alert(data.msg || 'Parcel added successfully');
          document.getElementById('admin-add-awbNumber').value = '';
          document.getElementById('admin-add-recipientName').value = '';
          document.getElementById('admin-add-recipientUnit').value = '';
          showViewParcels(); // Refresh the parcel list
        } else if (response.status === 409) {
          alert('Error: This AWB number is already logged. Please use a unique AWB number.');
        } else {
          alert(`Error: ${data.msg || 'Failed to add parcel. Please try again.'}`);
        }
      } catch (error) {
        console.error('Error adding parcel:', error);
        alert('An unexpected error occurred. Please try again.');
      }
    }

    async function loadParcels(containerId = 'admin-parcels-table-body') {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const parcels = await response.json();
      const parcelsList = document.getElementById('parcels-list');
      const adminParcelsTableBody = document.getElementById(containerId);

      parcelsList.innerHTML = '';
      if (adminParcelsTableBody) adminParcelsTableBody.innerHTML = '';

      if (parcels.length === 0) {
        parcelsList.innerHTML = '<p>No parcels found.</p>';
        if (adminParcelsTableBody) {
          adminParcelsTableBody.innerHTML = '<tr><td colspan="4">No parcels found.</td></tr>';
        }
        return;
      }

      parcels.forEach(parcel => {
        const status = parcel.collected_at ? 'Collected' : 'Pending';

        if (document.getElementById('resident-actions').classList.contains('hidden')) {
          // Admin flow: Use table
          if (adminParcelsTableBody) {
            const row = document.createElement('tr');
            row.dataset.awbNumber = parcel.awb_number;
            row.onclick = () => selectParcel(row);
            row.innerHTML = `
              <td>${parcel.awb_number}</td>
              <td>${parcel.recipient_name}</td>
              <td>${parcel.recipient_unit}</td>
              <td>${status}</td>
            `;
            adminParcelsTableBody.appendChild(row);
          }
        } else {
          // Resident flow: Use divs
          const div = document.createElement('div');
          div.textContent = `AWB: ${parcel.awb_number} - Recipient: ${parcel.recipient_name} - Unit: ${parcel.recipient_unit} - Status: ${status}`;
          div.dataset.awbNumber = parcel.awb_number;
          div.onclick = () => selectParcel(div);
          parcelsList.appendChild(div);
        }
      });
    }

    function selectParcel(element) {
      const parentId = element.parentElement.id;
      let parentSelector;
      if (parentId === 'parcels-list') {
        parentSelector = '#parcels-list div';
      } else if (parentId === 'admin-parcels-table-body') {
        parentSelector = '#admin-parcels-table-body tr';
      } else if (parentId === 'admin-parcels-table-body-edit') {
        parentSelector = '#admin-parcels-table-body-edit tr';
      } else if (parentId === 'admin-parcels-table-body-delete') {
        parentSelector = '#admin-parcels-table-body-delete tr';
      } else {
        console.error('Unknown parent for selection:', parentId);
        return;
      }

      document.querySelectorAll(parentSelector).forEach(item => item.classList.remove("selected"));
      element.classList.add("selected");
      selectedParcelAWB = element.dataset.awbNumber;
      console.log("üü¢ Selected parcel AWB:", selectedParcelAWB);

      // If in edit mode, populate the form
      if (parentId === 'admin-parcels-table-body-edit') {
        const row = element;
        document.getElementById('edit-awbNumber').value = row.cells[0].textContent;
        document.getElementById('edit-recipientName').value = row.cells[1].textContent;
        document.getElementById('edit-recipientUnit').value = row.cells[2].textContent;
      }
    }

    async function confirmParcelCollection() {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels/collect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ awbNumber: selectedParcelAWB }),
      });

      const data = await response.json();
      alert(data.msg);
      loadParcels();
    }

    async function loadUsers() {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/admin/users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const users = await response.json();
      const usersTableBody = document.getElementById('admin-users-table-body');
      usersTableBody.innerHTML = '';

      if (users.length === 0) {
        usersTableBody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>';
        return;
      }

      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td>${user.unit_number || 'N/A'}</td>
        `;
        usersTableBody.appendChild(row);
      });
    }

    async function addNewUser() {
      const name = document.getElementById('admin-user-name').value;
      const unitNumber = document.getElementById('admin-user-unit').value;
      const email = document.getElementById('admin-user-email').value;
      const password = document.getElementById('admin-user-password').value;
      const role = document.getElementById('admin-user-role').value;

      if (!name || !email || !password || !role) {
        alert('Please fill in all required fields.');
        return;
      }

      try {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/admin/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, unitNumber, email, password, role })
        });

        const data = await response.json();
        alert(data.msg);
        if (response.ok) {
          document.getElementById('admin-user-name').value = '';
          document.getElementById('admin-user-unit').value = '';
          document.getElementById('admin-user-email').value = '';
          document.getElementById('admin-user-password').value = '';
          document.getElementById('admin-user-role').value = 'resident';
          loadUsers();
        }
      } catch (error) {
        console.error('Error adding user:', error);
        alert('Failed to add user. Please try again.');
      }
    }

    async function saveParcelEdits() {
      const awbNumber = document.getElementById('edit-awbNumber').value.trim();
      const recipientName = document.getElementById('edit-recipientName').value.trim();
      const recipientUnit = document.getElementById('edit-recipientUnit').value.trim();

      if (!awbNumber || !recipientName || !recipientUnit) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const response = await fetch(`https://parcel-manager-backend.onrender.com/api/admin/parcels/${awbNumber}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            awbNumber,
            recipientName,
            recipientUnit
          })
        });

        const data = await response.json();
        alert(data.msg);
        if (response.ok) {
          showViewParcels(); // Refresh the parcel list
        }
      } catch (error) {
        console.error('Error editing parcel:', error);
        alert('Failed to edit parcel. Please try again.');
      }
    }

    async function deleteSelectedParcel() {
      if (!selectedParcelAWB) {
        alert("Please select a parcel first.");
        return;
      }

      const response = await fetch(`https://parcel-manager-backend.onrender.com/api/admin/parcels/${selectedParcelAWB}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      alert(data.msg);
      loadParcels('admin-parcels-table-body');
      loadParcels('admin-parcels-table-body-delete');
    }

    function logout() {
      token = null;
      selectedParcelAWB = null;
      hideAllSections();
      hideDashboardSections();
      document.getElementById('login-form').classList.remove('hidden');
    }

    function showAdminMain() {
      document.getElementById('admin-main-buttons').classList.remove('hidden');
      document.getElementById('admin-users-section').classList.add('hidden');
      document.getElementById('admin-parcels-section').classList.add('hidden');
    }

    function showAdminUsers() {
      document.getElementById('admin-main-buttons').classList.add('hidden');
      document.getElementById('admin-users-section').classList.remove('hidden');
      document.getElementById('admin-parcels-section').classList.add('hidden');
      loadUsers();
    }

    function showAdminParcels() {
      document.getElementById('admin-main-buttons').classList.add('hidden');
      document.getElementById('admin-users-section').classList.add('hidden');
      document.getElementById('admin-parcels-section').classList.remove('hidden');
      document.getElementById('admin-parcels-buttons').classList.remove('hidden');
      document.getElementById('admin-view-parcels').classList.add('hidden');
      document.getElementById('admin-edit-parcels').classList.add('hidden');
      document.getElementById('admin-add-parcels').classList.add('hidden');
      document.getElementById('admin-delete-parcels').classList.add('hidden');
    }

    function showViewParcels() {
      document.getElementById('admin-parcels-buttons').classList.add('hidden');
      document.getElementById('admin-view-parcels').classList.remove('hidden');
      document.getElementById('admin-edit-parcels').classList.add('hidden');
      document.getElementById('admin-add-parcels').classList.add('hidden');
      document.getElementById('admin-delete-parcels').classList.add('hidden');
      loadParcels('admin-parcels-table-body');
    }

    function showEditParcels() {
      document.getElementById('admin-parcels-buttons').classList.add('hidden');
      document.getElementById('admin-view-parcels').classList.add('hidden');
      document.getElementById('admin-edit-parcels').classList.remove('hidden');
      document.getElementById('admin-add-parcels').classList.add('hidden');
      document.getElementById('admin-delete-parcels').classList.add('hidden');
      loadParcels('admin-parcels-table-body-edit');
    }

    function showAddParcels() {
      document.getElementById('admin-parcels-buttons').classList.add('hidden');
      document.getElementById('admin-view-parcels').classList.add('hidden');
      document.getElementById('admin-edit-parcels').classList.add('hidden');
      document.getElementById('admin-add-parcels').classList.remove('hidden');
      document.getElementById('admin-delete-parcels').classList.add('hidden');
    }

    function showDeleteParcels() {
      document.getElementById('admin-parcels-buttons').classList.add('hidden');
      document.getElementById('admin-view-parcels').classList.add('hidden');
      document.getElementById('admin-edit-parcels').classList.add('hidden');
      document.getElementById('admin-add-parcels').classList.add('hidden');
      document.getElementById('admin-delete-parcels').classList.remove('hidden');
      loadParcels('admin-parcels-table-body-delete');
    }

    function backToAdminMain() {
      showAdminMain();
    }

    let token = null;
    let selectedParcelAWB = null;
    let startScanner;
    let stopScanner;

    document.addEventListener("DOMContentLoaded", function () {
      if (typeof Quagga === "undefined") {
        console.error("‚ùå Quagga2 failed to load.");
        alert("Barcode scanner library failed to load.");
        return;
      }
      console.log("üü¢ Quagga2 loaded successfully");

      hideAllSections();
      hideDashboardSections();
      document.getElementById('login-form').classList.remove('hidden');

      startScanner = async function (onDetectedCallback) {
        console.log("üü¢ startScanner called");
        const scannerContainer = document.getElementById('scanner');
        const reader = document.getElementById('reader');
        reader.innerHTML = "";
        scannerContainer.classList.remove('hidden');
        scannerContainer.style.display = 'block';
        reader.style.display = 'block';

        scannerContainer.offsetHeight;
        reader.offsetHeight;

        console.log("üü¢ Scanner container styles:", window.getComputedStyle(scannerContainer));
        console.log("üü¢ Reader styles:", window.getComputedStyle(reader));

        try {
          await Quagga.init({
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: reader,
              constraints: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "environment"
              }
            },
            decoder: {
              readers: ["code_128_reader", "ean_reader", "upc_reader"],
              multiple: false
            },
            locate: true
          });

          console.log("üü¢ Quagga2 initialized successfully");
          Quagga.start();

          setTimeout(() => {
            const video = reader.querySelector('video');
            if (!video) {
              console.error("‚ùå No video element found in #reader");
              alert("Camera stream failed to load: Video element not found.");
              stopScanner();
              return;
            }
            if (!video.srcObject) {
              console.error("‚ùå Video stream not found");
              alert("Camera stream failed to load: No stream attached.");
              stopScanner();
              return;
            }
            console.log("üü¢ Video element found:", video);
            console.log("üü¢ Video stream active");
            console.log("üü¢ Video styles:", window.getComputedStyle(video));
          }, 1000);

          Quagga.onDetected((result) => {
            if (result && result.codeResult && result.codeResult.code) {
              onDetectedCallback(result);
            }
          });
        } catch (err) {
          console.error("‚ùå Quagga2 init error:", err);
          alert("Camera initialization failed: " + err.message);
          scannerContainer.classList.add('hidden');
        }
      };

      stopScanner = function () {
        console.log("üü¢ stopScanner called");
        Quagga.stop();
        Quagga.offDetected();
        document.getElementById('scanner').classList.add('hidden');
        document.getElementById('manualAWB').value = '';
      };

      function playVideo() {
        const video = document.getElementById('reader').querySelector('video');
        if (video) {
          video.play().catch(err => {
            console.error("‚ùå Video play error:", err);
            alert("Failed to play video stream: " + err.message);
          });
        }
      }

      function startScannerForAWB() {
        startScanner(function (result) {
          const barcode = result.codeResult.code;
          console.log("üü¢ Barcode value:", barcode);
          document.getElementById('awbNumber').value = barcode;
          stopScanner();
        });
      }

      function startScannerForAdminAdd() {
        startScanner(function (result) {
          const barcode = result.codeResult.code;
          console.log("üü¢ Barcode value:", barcode);
          document.getElementById('admin-add-awbNumber').value = barcode;
          stopScanner();
        });
      }

      document.getElementById('scanAWB').addEventListener('click', startScannerForAWB);
      document.getElementById('admin-scanAWB').addEventListener('click', startScannerForAdminAdd);
      document.querySelector('#scanner button[onclick="stopScanner()"]').addEventListener('click', stopScanner);
    });

    function startParcelScan() {
      if (!selectedParcelAWB) {
        alert("Please select a parcel first.");
        return;
      }
      console.log("üü¢ Starting parcel scan for AWB:", selectedParcelAWB);

      const scannerContainer = document.getElementById('scanner');
      scannerContainer.classList.remove('hidden');
      scannerContainer.style.display = 'block';
      scannerContainer.offsetHeight;

      startScanner(function (result) {
        const scannedCode = result.codeResult.code;
        console.log("üü¢ Scanned code:", scannedCode);
        if (scannedCode === selectedParcelAWB) {
          stopScanner();
          confirmParcelCollection();
        } else {
          alert("‚ùå Wrong parcel scanned. Please scan the correct barcode.");
        }
      });
    }

    async function manualCollectParcel() {
      const manualAWB = document.getElementById('manualAWB').value.trim();
      if (!manualAWB && !selectedParcelAWB) {
        alert("Please select a parcel or enter an AWB number.");
        return;
      }
      const awbToCheck = manualAWB || selectedParcelAWB;
      if (awbToCheck === selectedParcelAWB) {
        stopScanner();
        confirmParcelCollection();
      } else {
        alert("‚ùå Invalid AWB. Please enter the correct AWB number.");
      }
    }
  </script>
</body>
</html>
