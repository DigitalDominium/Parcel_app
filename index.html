<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parcel App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    #reader {
      position: relative;
      width: 100%;
      height: 300px;
      border: 1px solid #ccc;
      background: #000;
      overflow: visible;
    }

    #reader video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      z-index: 1;
      display: block !important;
    }

    #reader canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 2;
      display: none;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      max-width: 600px;
      width: 100%;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1, h2, h3, h4 {
      text-align: center;
      margin-bottom: 15px;
    }

    input, select, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .hidden {
      display: none !important;
    }

    #parcels-list div, #admin-parcels-list div, #admin-users-list div {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      text-align: center;
    }

    #parcels-list div.selected, #admin-parcels-list div.selected {
      background: #d1e7fd;
    }

    #scanner {
      z-index: 10;
    }

    .button-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .camera-button {
      width: auto;
      padding: 12px;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      #app {
        width: 90%;
        padding: 15px;
      }

      input, button {
        padding: 10px;
        font-size: 14px;
      }

      h1 {
        font-size: 24px;
      }

      h2, h3, h4 {
        font-size: 18px;
      }

      .camera-button {
        padding: 10px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      #app {
        width: 95%;
        padding: 10px;
      }

      h1 {
        font-size: 20px;
      }

      h2, h3, h4 {
        font-size: 16px;
      }

      input, button {
        padding: 8px;
        font-size: 12px;
      }

      #parcels-list div, #admin-parcels-list div, #admin-users-list div {
        padding: 8px;
        font-size: 14px;
      }

      .camera-button {
        padding: 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Parcel Management</h1>

    <div id="login-form">
      <h2>Login</h2>
      <form id="loginForm" onsubmit="event.preventDefault(); login();">
        <input id="login-email" type="email" placeholder="Email" autocomplete="email" required />
        <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" required />
        <button type="submit">Login</button>
      </form>
      <button onclick="showRegister()">Register</button>
    </div>

    <div id="register-form" class="hidden">
      <h2>Register</h2>
      <input id="name" placeholder="Name" autocomplete="name" />
      <input id="unit" placeholder="Unit Number" autocomplete="off" />
      <input id="email" placeholder="Email" autocomplete="email" />
      <input id="password" type="password" placeholder="Password" autocomplete="new-password" />
      <button onclick="register()">Sign Up</button>
      <button onclick="showLogin()">Back to Login</button>
    </div>

    <div id="dashboard" class="hidden">
      <h2>Welcome, <span id="user-name"></span>!</h2>

      <div id="guard-actions" class="hidden">
        <h3>Log New Parcel</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input id="awbNumber" placeholder="AWB Number" autocomplete="off" />
          <button id="scanAWB" onclick="startScannerForAWB()" class="camera-button" aria-label="Scan AWB barcode">
            üì∑
          </button>
        </div>
        <input id="recipientName" placeholder="Recipient Name" autocomplete="name" />
        <input id="recipientUnit" placeholder="Unit Number" autocomplete="off" />
        <button onclick="logParcel()">Log Parcel</button>
      </div>

      <div id="resident-actions" class="hidden">
        <h3>Your Parcels</h3>
        <div id="parcels-list"></div>
        <div class="button-group">
          <button onclick="manualCollectParcel()">Collect Parcel</button>
          <button onclick="startParcelScan()" class="camera-button" aria-label="Scan parcel barcode">
            üì∑
          </button>
        </div>
      </div>

      <div id="admin-actions" class="hidden">
        <h3>Admin Dashboard</h3>
        <h4>Users</h4>
        <div id="admin-users-list"></div>
        <h4>Parcels</h4>
        <div id="admin-parcels-list"></div>
        <button onclick="deleteSelectedParcel()">Delete Selected Parcel</button>
      </div>

      <button onclick="logout()">Logout</button>
    </div>

    <div id="scanner" class="hidden" style="width: 100%; margin-top: 10px;">
      <div id="reader" style="width: 100%; height: 300px; border: 1px solid #ccc;"></div>
      <button onclick="playVideo()">Start Camera</button>
      <input id="manualAWB" placeholder="Enter AWB manually if camera fails" style="margin-top: 10px;" autocomplete="off">
      <button onclick="manualCollectParcel()">Submit Manual AWB</button>
      <button onclick="stopScanner()">‚ùå Close Scanner</button>
    </div>
  </div>

  <script>
    function hideAllSections() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('scanner').classList.add('hidden');
    }

    function hideDashboardSections() {
      document.getElementById('guard-actions').classList.add('hidden');
      document.getElementById('resident-actions').classList.add('hidden');
      document.getElementById('admin-actions').classList.add('hidden');
      document.getElementById('scanner').classList.add('hidden');
    }

    function showRegister() {
      hideAllSections();
      document.getElementById('register-form').classList.remove('hidden');
    }

    function showLogin() {
      hideAllSections();
      document.getElementById('login-form').classList.remove('hidden');
    }

    async function register() {
      console.log("üü¢ register() called");
      const name = document.getElementById('name').value;
      const unitNumber = document.getElementById('unit').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      console.log("üü¢ Form Data:", { name, unitNumber, email, password });

      if (!name || !unitNumber || !email || !password) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, unitNumber, email, password }),
        });

        console.log("üü¢ Fetch Response Status:", response.status);
        const data = await response.json();
        console.log("üü¢ Response Data:", data);

        alert(data.msg);
        if (data.msg === 'Registration successful') {
          showLogin();
        }
      } catch (error) {
        console.error("‚ùå Error during registration:", error);
        alert('Failed to register. Please try again.');
      }
    }

    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (data.token) {
        token = data.token;
        hideAllSections();
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('user-name').textContent = data.name;

        hideDashboardSections();
        if (data.role === 'guard') {
          document.getElementById('guard-actions').classList.remove('hidden');
        } else if (data.role === 'resident') {
          document.getElementById('resident-actions').classList.remove('hidden');
          loadParcels();
        } else if (data.role === 'admin') {
          document.getElementById('admin-actions').classList.remove('hidden');
          loadUsers();
          loadParcels();
        }
        alert(`Logged in as ${data.role}`);
      } else {
        alert(data.msg);
      }
    }

    async function logParcel() {
      const awbNumber = document.getElementById('awbNumber').value.trim();
      const recipientName = document.getElementById('recipientName').value.trim();
      const recipientUnit = document.getElementById('recipientUnit').value.trim();

      if (!awbNumber || !recipientName || !recipientUnit) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            awbNumber,
            recipientName,
            recipientUnit
          })
        });

        const data = await response.json();
        if (response.ok) {
          alert(data.msg || 'Parcel logged successfully');
          document.getElementById('awbNumber').value = '';
          document.getElementById('recipientName').value = '';
          document.getElementById('recipientUnit').value = '';
        } else if (response.status === 409) {
          alert('Error: This AWB number is already logged. Please use a unique AWB number.');
        } else {
          alert(`Error: ${data.msg || 'Failed to log parcel. Please try again.'}`);
        }
      } catch (error) {
        console.error('Error logging parcel:', error);
        alert('An unexpected error occurred. Please try again.');
      }
    }

    async function loadParcels() {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const parcels = await response.json();
      const parcelsList = document.getElementById('parcels-list');
      const adminParcelsList = document.getElementById('admin-parcels-list');

      parcelsList.innerHTML = '';
      if (adminParcelsList) adminParcelsList.innerHTML = '';

      if (parcels.length === 0) {
        parcelsList.innerHTML = '<p>No parcels found.</p>';
        if (adminParcelsList) adminParcelsList.innerHTML = '<p>No parcels found.</p>';
        return;
      }

      parcels.forEach(parcel => {
        const status = parcel.collected_at ? 'Collected' : 'Pending';
        const div = document.createElement('div');
        div.textContent = `AWB: ${parcel.awb_number} - Recipient: ${parcel.recipient_name} - Unit: ${parcel.recipient_unit} - Status: ${status}`;
        div.dataset.awbNumber = parcel.awb_number;
        div.onclick = () => selectParcel(div);

        if (document.getElementById('resident-actions').classList.contains('hidden')) {
          if (adminParcelsList) adminParcelsList.appendChild(div.cloneNode(true));
        } else {
          parcelsList.appendChild(div);
        }
      });
    }

    function selectParcel(element) {
      const parent = element.parentElement.id === 'parcels-list' ? '#parcels-list' : '#admin-parcels-list';
      document.querySelectorAll(`${parent} div`).forEach(div => div.classList.remove("selected"));
      element.classList.add("selected");
      selectedParcelAWB = element.dataset.awbNumber;
    }

    async function confirmParcelCollection() {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels/collect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ awbNumber: selectedParcelAWB }),
      });

      const data = await response.json();
      alert(data.msg);
      loadParcels();
    }

    async function loadUsers() {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/admin/users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const users = await response.json();
      const usersList = document.getElementById('admin-users-list');
      usersList.innerHTML = '';

      if (users.length === 0) {
        usersList.innerHTML = '<p>No users found.</p>';
        return;
      }

      users.forEach(user => {
        const div = document.createElement('div');
        div.textContent = `Name: ${user.name}, Email: ${user.email}, Role: ${user.role}, Unit: ${user.unit_number || 'N/A'}`;
        usersList.appendChild(div);
      });
    }

    async function deleteSelectedParcel() {
      if (!selectedParcelAWB) {
        alert("Please select a parcel first.");
        return;
      }

      const response = await fetch(`https://parcel-manager-backend.onrender.com/api/admin/parcels/${selectedParcelAWB}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      alert(data.msg);
      loadParcels();
    }

    function logout() {
      token = null;
      selectedParcelAWB = null;
      hideAllSections();
      hideDashboardSections();
      document.getElementById('login-form').classList.remove('hidden');
    }

    let token = null;
    let selectedParcelAWB = null;
    let startScanner;
    let stopScanner;

    document.addEventListener("DOMContentLoaded", function () {
      if (typeof Quagga === "undefined") {
        console.error("‚ùå Quagga2 failed to load.");
        alert("Barcode scanner library failed to load.");
        return;
      }
      console.log("üü¢ Quagga2 loaded successfully");

      hideAllSections();
      hideDashboardSections();
      document.getElementById('login-form').classList.remove('hidden');

      startScanner = async function (onDetectedCallback) {
        console.log("üü¢ startScanner called");
        const scannerContainer = document.getElementById('scanner');
        const reader = document.getElementById('reader');
        reader.innerHTML = "";
        scannerContainer.classList.remove('hidden');
        scannerContainer.style.display = 'block';
        reader.style.display = 'block';

        scannerContainer.offsetHeight;
        reader.offsetHeight;

        console.log("üü¢ Scanner container styles:", window.getComputedStyle(scannerContainer));
        console.log("üü¢ Reader styles:", window.getComputedStyle(reader));

        try {
          await Quagga.init({
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: reader,
              constraints: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "environment"
              }
            },
            decoder: {
              readers: ["code_128_reader", "ean_reader", "upc_reader"],
              multiple: false
            },
            locate: true
          });

          console.log("üü¢ Quagga2 initialized successfully");
          Quagga.start();

          setTimeout(() => {
            const video = reader.querySelector('video');
            if (!video) {
              console.error("‚ùå No video element found in #reader");
              alert("Camera stream failed to load: Video element not found.");
              stopScanner();
              return;
            }
            if (!video.srcObject) {
              console.error("‚ùå Video stream not found");
              alert("Camera stream failed to load: No stream attached.");
              stopScanner();
              return;
            }
            console.log("üü¢ Video element found:", video);
            console.log("üü¢ Video stream active");
            console.log("üü¢ Video styles:", window.getComputedStyle(video));
          }, 1000);

          Quagga.onDetected((result) => {
            if (result && result.codeResult && result.codeResult.code) {
              onDetectedCallback(result);
            }
          });
        } catch (err) {
          console.error("‚ùå Quagga2 init error:", err);
          alert("Camera initialization failed: " + err.message);
          scannerContainer.classList.add('hidden');
        }
      };

      stopScanner = function () {
        console.log("üü¢ stopScanner called");
        Quagga.stop();
        Quagga.offDetected();
        document.getElementById('scanner').classList.add('hidden');
        document.getElementById('manualAWB').value = '';
      };

      function playVideo() {
        const video = document.getElementById('reader').querySelector('video');
        if (video) {
          video.play().catch(err => {
            console.error("‚ùå Video play error:", err);
            alert("Failed to play video stream: " + err.message);
          });
        }
      }

      function startScannerForAWB() {
        startScanner(function (result) {
          const barcode = result.codeResult.code;
          console.log("üü¢ Barcode value:", barcode);
          document.getElementById('awbNumber').value = barcode;
          stopScanner();
        });
      }

      document.getElementById('scanAWB').addEventListener('click', startScannerForAWB);
      document.querySelector('#scanner button[onclick="stopScanner()"]').addEventListener('click', stopScanner);
    });

    function startParcelScan() {
      if (!selectedParcelAWB) {
        alert("Please select a parcel first.");
        return;
      }
      console.log("üü¢ Starting parcel scan for AWB:", selectedParcelAWB);

      const scannerContainer = document.getElementById('scanner');
      scannerContainer.classList.remove('hidden');
      scannerContainer.style.display = 'block';
      scannerContainer.offsetHeight;

      startScanner(function (result) {
        const scannedCode = result.codeResult.code;
        console.log("üü¢ Scanned code:", scannedCode);
        if (scannedCode === selectedParcelAWB) {
          stopScanner();
          confirmParcelCollection();
        } else {
          alert("‚ùå Wrong parcel scanned. Please scan the correct barcode.");
        }
      });
    }

    async function manualCollectParcel() {
      const manualAWB = document.getElementById('manualAWB').value.trim();
      if (!manualAWB && !selectedParcelAWB) {
        alert("Please select a parcel or enter an AWB number.");
        return;
      }
      const awbToCheck = manualAWB || selectedParcelAWB;
      if (awbToCheck === selectedParcelAWB) {
        stopScanner();
        confirmParcelCollection();
      } else {
        alert("‚ùå Invalid AWB. Please enter the correct AWB number.");
      }
    }
  </script>
</body>
</html>
