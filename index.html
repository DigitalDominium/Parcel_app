<body>
  <div id="app">
    <h1>Parcel Management</h1>

    <div id="login-form">
      <h2>Login</h2>
      <input id="login-email" placeholder="Email" />
      <input id="login-password" type="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <button onclick="showRegister()">Register</button>
    </div>

    <div id="register-form" class="hidden">
      <h2>Register</h2>
      <input id="name" placeholder="Name" />
      <input id="unit" placeholder="Unit Number" />
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button onclick="register()">Sign Up</button>
      <button onclick="showLogin()">Back to Login</button>
    </div>

    <div id="dashboard" class="hidden">
      <h2>Welcome, <span id="user-name"></span>!</h2>

      <div id="guard-actions" class="hidden">
        <h3>Log New Parcel</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input id="awbNumber" placeholder="AWB Number" />
          <button id="scanAWB" onclick="startScanner()">
            üì∑
          </button>
        </div>
        <input id="recipientName" placeholder="Recipient Name" />
        <input id="recipientUnit" placeholder="Unit Number" />
        <button onclick="logParcel()">Log Parcel</button>
        
        <!-- Hidden Barcode Scanner -->
        <div id="scanner" class="hidden" style="width: 100%; margin-top: 10px;">
          <div id="reader" style="width: 100%;"></div>
          <button onclick="stopScanner()">‚ùå Close Scanner</button>
        </div>
      </div>

      <div id="resident-actions" class="hidden">
        <h3>Your Parcels</h3>
        <div id="parcels-list"></div>
        <button onclick="collectParcel()">Collect Parcel</button>
      </div>

      <!-- Admin Dashboard -->
      <div id="admin-actions" class="hidden">
        <h3>Admin Dashboard</h3>
        <h4>Users</h4>
        <div id="admin-users-list"></div>
        <h4>Parcels</h4>
        <div id="admin-parcels-list"></div>
        <button onclick="deleteSelectedParcel()">Delete Selected Parcel</button>
      </div>

      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    // Function to hide all top-level sections
    function hideAllSections() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }

    // Function to hide all dashboard sub-sections
    function hideDashboardSections() {
      document.getElementById('guard-actions').classList.add('hidden');
      document.getElementById('resident-actions').classList.add('hidden');
      document.getElementById('admin-actions').classList.add('hidden');
      document.getElementById('scanner').classList.add('hidden'); // Ensure scanner starts hidden
    }

    function showRegister() {
      hideAllSections();
      document.getElementById('register-form').classList.remove('hidden');
    }

    function showLogin() {
      hideAllSections();
      document.getElementById('login-form').classList.remove('hidden');
    }

    async function register() {
      const name = document.getElementById('name').value;
      const unitNumber = document.getElementById('unit').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, unitNumber, email, password }),
      });

      const data = await response.json();
      alert(data.msg);
      if (data.msg === 'Registration successful') {
        showLogin();
      }
    }

    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (data.token) {
        token = data.token;
        hideAllSections();
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('user-name').textContent = email;

        hideDashboardSections();
        if (data.role === 'guard') {
          document.getElementById('guard-actions').classList.remove('hidden');
        } else if (data.role === 'resident') {
          document.getElementById('resident-actions').classList.remove('hidden');
          loadParcels();
        } else if (data.role === 'admin') {
          document.getElementById('admin-actions').classList.remove('hidden');
          loadUsers();
          loadParcels();
        }
        alert(`Logged in as ${data.role}`);
      } else {
        alert(data.msg);
      }
    }

    async function logParcel() {
      const awbNumber = document.getElementById('awbNumber').value.trim();
      const recipientName = document.getElementById('recipientName').value.trim();
      const recipientUnit = document.getElementById('recipientUnit').value.trim();

      if (!awbNumber || !recipientName || !recipientUnit) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            awbNumber,
            recipientName,
            recipientUnit
          })
        });

        const data = await response.json();
        if (response.ok) {
          alert(data.msg || 'Parcel logged successfully');
          document.getElementById('awbNumber').value = '';
          document.getElementById('recipientName').value = '';
          document.getElementById('recipientUnit').value = '';
        } else if (response.status === 409) {
          alert('Error: This AWB number is already logged. Please use a unique AWB number.');
        } else {
          alert(`Error: ${data.msg || 'Failed to log parcel. Please try again.'}`);
        }
      } catch (error) {
        console.error('Error logging parcel:', error);
        alert('An unexpected error occurred. Please try again.');
      }
    }

    async function loadParcels() {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const parcels = await response.json();
      const parcelsList = document.getElementById('parcels-list');
      const adminParcelsList = document.getElementById('admin-parcels-list');
      
      parcelsList.innerHTML = '';
      if (adminParcelsList) adminParcelsList.innerHTML = '';

      if (parcels.length === 0) {
        parcelsList.innerHTML = '<p>No parcels found.</p>';
        if (adminParcelsList) adminParcelsList.innerHTML = '<p>No parcels found.</p>';
        return;
      }

      parcels.forEach(parcel => {
        const status = parcel.collected_at ? 'Collected' : 'Pending';
        const div = document.createElement('div');
        div.textContent = `AWB: ${parcel.awb_number} - Recipient: ${parcel.recipient_name} - Unit: ${parcel.recipient_unit} - Status: ${status}`;
        div.dataset.awbNumber = parcel.awb_number;
        div.onclick = () => selectParcel(div);

        if (document.getElementById('resident-actions').classList.contains('hidden')) {
          if (adminParcelsList) adminParcelsList.appendChild(div.cloneNode(true));
        } else {
          parcelsList.appendChild(div);
        }
      });
    }

    function selectParcel(element) {
      const parent = element.parentElement.id === 'parcels-list' ? '#parcels-list' : '#admin-parcels-list';
      document.querySelectorAll(`${parent} div`).forEach(div => div.classList.remove("selected"));
      element.classList.add("selected");
      selectedParcelAWB = element.dataset.awbNumber;
    }

    async function collectParcel() {
      if (!selectedParcelAWB) {
        alert("Please select a parcel first.");
        return;
      }

      const response = await fetch('https://parcel-manager-backend.onrender.com/api/parcels/collect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ awbNumber: selectedParcelAWB }),
      });

      const data = await response.json();
      alert(data.msg);
      loadParcels();
    }

    async function loadUsers() {
      const response = await fetch('https://parcel-manager-backend.onrender.com/api/admin/users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const users = await response.json();
      const usersList = document.getElementById('admin-users-list');
      usersList.innerHTML = '';

      if (users.length === 0) {
        usersList.innerHTML = '<p>No users found.</p>';
        return;
      }

      users.forEach(user => {
        const div = document.createElement('div');
        div.textContent = `Name: ${user.name}, Email: ${user.email}, Role: ${user.role}, Unit: ${user.unit_number || 'N/A'}`;
        usersList.appendChild(div);
      });
    }

    async function deleteSelectedParcel() {
      if (!selectedParcelAWB) {
        alert("Please select a parcel first.");
        return;
      }

      const response = await fetch(`https://parcel-manager-backend.onrender.com/api/admin/parcels/${selectedParcelAWB}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      alert(data.msg);
      loadParcels();
    }

    function logout() {
      token = null;
      selectedParcelAWB = null;
      hideAllSections();
      hideDashboardSections();
      document.getElementById('login-form').classList.remove('hidden');
    }

    let token = null;
    let selectedParcelAWB = null;

    // Barcode Scanner Functions
    let startScanner;
    let stopScanner;

    document.addEventListener("DOMContentLoaded", function () {
      if (typeof Quagga === "undefined") {
        console.error("‚ùå QuaggaJS failed to load.");
        return;
      }
      console.log("üü¢ QuaggaJS loaded successfully");

      // Ensure initial state: only login form visible
      hideAllSections();
      hideDashboardSections();
      document.getElementById('login-form').classList.remove('hidden');

      startScanner = function () {
        console.log("üü¢ startScanner called");
        document.getElementById('scanner').classList.remove('hidden');

        Quagga.init({
          inputStream: {
            type: "LiveStream",
            constraints: {
              width: 640,
              height: 480,
              facingMode: "environment"
            },
            target: document.getElementById("reader")
          },
          locator: {
            patchSize: "medium",
            halfSample: true
          },
          numOfWorkers: 4,
          locate: true,
          decoder: {
            readers: ["code_128_reader", "ean_reader", "upc_reader"]
          }
        }, function (err) {
          if (err) {
            console.error("‚ùå Quagga init error:", err);
            return;
          }
          console.log("üü¢ Quagga initialized successfully");
          Quagga.start();
        });

        Quagga.onDetected(function (result) {
          console.log("üü¢ Barcode detected:", result);
          let barcode = result.codeResult.code;
          console.log("üü¢ Barcode value:", barcode);
          document.getElementById('awbNumber').value = barcode;
          stopScanner();
        });
      };

      stopScanner = function () {
        console.log("üü¢ stopScanner called");
        Quagga.stop();
        document.getElementById('scanner').classList.add('hidden');
      };

      document.getElementById('scanAWB').addEventListener('click', startScanner);
      document.querySelector('#scanner button').addEventListener('click', stopScanner);
    });
  </script>
</body>
